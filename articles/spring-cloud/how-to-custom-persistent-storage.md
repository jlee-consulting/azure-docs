---
title: How to enable your own persistent storage in Azure Spring Apps | Microsoft Docs
description: How to bring your own storage as persistent storages in Azure Spring Apps
author: karlerickson
ms.service: spring-cloud
ms.topic: conceptual
ms.date: 2/18/2022
ms.author: xuycao
ms.custom: devx-track-java, devx-track-azurecli, event-tier1-build-2022
---

# How to enable your own persistent storage in Azure Spring Apps

> [!NOTE]
> Azure Spring Apps is the new name for the Azure Spring Cloud service. Although the service has a new name, you'll see the old name in some places for a while as we work to update assets such as screenshots, videos, and diagrams.

**This article applies to:** ✔️ Java ✔️ C#

**This article applies to:** ✔️ Basic/Standard tier ✔️ Enterprise tier

This article shows you how to enable your own persistent storage in Azure Spring Apps.

When you use the built-in persistent storage in Azure Spring Apps, artifacts generated by your application are uploaded into Azure Storage Accounts. Microsoft controls the encryption-at-rest and lifetime management policies for those artifacts. 

With Bring Your Own Storage, these artifacts are uploaded into a storage account that you control. That means you control the encryption-at-rest policy, the lifetime management policy and network access. You will, however, be responsible for the costs associated with that storage account.

## Prerequisites

* An existing Azure Storage Account and a pre-created Azure File Share. If you need to create a storage account and file share in Azure, see [Create an Azure file share](../storage/files/storage-how-to-create-file-share.md).
* The [Azure Spring Apps extension](/cli/azure/azure-cli-extensions-overview) for the Azure CLI

> [!IMPORTANT]
> If you deployed your Azure Spring Apps in your own virtual network and you want the storage account to be accessed only from the virtual network, consult the following guidance:
> - [Use private endpoints for Azure Storage](../storage/common/storage-private-endpoints.md)
> - [Configure Azure Storage firewalls and virtual networks](../storage/common/storage-network-security.md), especially the [Grant access from a virtual network using service endpoint](../storage/common/storage-network-security.md#grant-access-from-a-virtual-network) section

## Mount your own extra persistent storage to applications

> [!NOTE]
> Updating persistent storage will result in the restart of applications.

### [Portal](#tab/Azure-portal)

Use the following steps to bind an Azure Storage account as a storage resource in your Azure Spring Apps and create an app with your own persistent storage.

1. Go to the service **Overview** page, then select **Storage** in the left-hand navigation pane.

1. On the **Storage** page, select **Add storage**, add the values in the following table, and then select **Apply**.

   | Setting      | Value                                                                                      |
   |--------------|--------------------------------------------------------------------------------------------|
   | Storage name | The name of the storage resource, which is a service-level resource in Azure Spring Apps. |
   | Account name | The name of the storage account.                                                           |
   | Account key  | The storage account key.                                                                   |

   :::image type="content" source="media/how-to-custom-persistent-storage/add-storage-resource.png" alt-text="Screenshot of Azure portal showing the Storage page and the 'Add storage' pane." lightbox="media/how-to-custom-persistent-storage/add-storage-resource.png":::

1. Go to the **Apps** page, then select an application to mount the persistent storage.

   :::image type="content" source="media/how-to-custom-persistent-storage/select-app-mount-persistent-storage.png" alt-text="Screenshot of Azure portal Apps page." lightbox="media/how-to-custom-persistent-storage/select-app-mount-persistent-storage.png":::

1. Select **Configuration**, then select **Persistent Storage**.

1. Select **Add persistent storage**, add the values in the following table, and then select **Apply**.

    | Setting                 | Value                                                          |
    |-------------------------|----------------------------------------------------------------|
    | Storage name            | The name of the storage resource that you entered earlier.     |
    | Persistent storage type | **AzureFileVolume**                                            |
    | Share name              | The name of the Azure File share in the Azure Storage account. |
    | Mount path              | A unique mount path.                                           |
    | Mount options           | Optional                                                       |
    | Read only               | Optional                                                       |

   :::image type="content" source="media/how-to-custom-persistent-storage/add-persistent-storage.png" alt-text="Screenshot of Azure portal 'Add persistent storage' form.":::

1. Select **Save** to apply all the configuration changes.

   :::image type="content" source="media/how-to-custom-persistent-storage/save-persistent-storage-changes.png" alt-text="Screenshot of Azure portal Persistent Storage section of the Configuration page." lightbox="media/how-to-custom-persistent-storage/save-persistent-storage-changes.png":::

### [CLI](#tab/Azure-CLI)

You can enable your own storage with the Azure CLI by using the following steps.

1. Use the following command to bind your Azure Storage account as a storage resource in your Azure Spring Apps instance:

    ```azurecli
   az spring storage add \
       --resource-group <resource-group-name> \
       --service <Azure-Spring-Apps-instance-name> \
       --name <storage-resource-name> \
       --storage-type StorageAccount \
       --account-name <account-name> \
       --account-key <account-key>
    ```

1. Use the following command to create an app with your own persistent storage.

   ```azurecli
   az spring app create \
       --resource-group <resource-group-name> \
       --service <Azure-Spring-Apps-instance-name> \
       --name <app-name> \
       --persistent-storage <path-to-JSON-file>
   ```

   Here's a sample of the JSON file that is passed to the `--persistent-storage` parameter in the create command:

   ```json
   {
      "customPersistentDisks": [
         {
             "storageName": "<storage-resource-name>",
             "customPersistentDiskProperties": {
                 "type": "AzureFileVolume",
                 "shareName": "<Azure-file-share-name>",
                 "mountPath": "<unique-mount-path>",
                 "mountOptions": [
                     "uid=0",
                     "gid=0"
                  ],
                  "readOnly": false 
               }
         },
         {
             "storageName": "<storage-resource-name>",
             "customPersistentDiskProperties": {
                 "type": "AzureFileVolume",
                 "shareName": "<Azure-file-share-name>",
                 "mountPath": "<unique-mount-path>",
                 "readOnly": true
             }
         }
      ]
   }
   ```

1. Optionally, add extra persistent storage to an existing app using the following command:

   ```azurecli
   az spring app append-persistent-storage \
       --resource-group <resource-group-name> \
       --service <Azure-Spring-Apps-instance-name> \
       --name <app-name> \
       --persistent-storage-type AzureFileVolume \
       --share-name <Azure-file-share-name> \
       --mount-path <unique-mount-path> \
       --storage-name <storage-resource-name>
   ```

1. Optionally, list all existing persistent storage of a specific storage resource using the following command:

   ```azurecli
   az spring storage list-persistent-storage \
       --resource-group <resource-group-name> \
       --service <Azure-Spring-Apps-instance-name> \
       --name <storage-resource-name>
   ```

---

## Use best practices

Use the following best practices when adding your own persistent storage to Azure Spring Apps.

* To avoid potential latency issues, place the Azure Spring Apps instance and the Azure Storage Account in the same Azure region.

* In the Azure Storage Account, avoid regenerating the account key that's being used. The storage account contains two different keys. Use a step-by-step approach to ensure that the persistent storage remains available to the applications during key regeneration.

   For example, assuming that you used key1 to bind a storage account to Azure Spring Apps, you would use the following steps:

   1. Regenerate key2.
   1. Update the account key of the storage resource to use the regenerated key2.
   1. Restart the applications that mount the persistent storage from this storage resource. (You can use `az spring storage list-persistent-storage` to list all related applications.)
   1. Regenerate key1.

* If you delete an Azure Storage Account or Azure File Share, remove the corresponding storage resource or persistent storage in the applications to avoid possible errors.

## FAQs

The following are frequently asked questions (FAQ) about using your own persistent storage with Azure Spring Apps.

* If I have built-in persistent storage enabled, and then I enabled my own storage as extra persistent storage, will my data be migrated into my Storage Account?

   *No. But we're going to provide a document to help you do the migration yourself soon.*

* What are the reserved mount paths?

   *These mount paths are reserved by the Azure Spring Apps service:*

   * */tmp*
   * */persistent*
   * */secrets*
   * */app-insights/agents*
   * */etc/azure-spring-cloud/certs*
   * */app-insights/agents/settings*
   * */app-lifecycle/settings*

* What are the available mount options?

   *We currently support the following mount options:*

   * `uid`
   * `gid`
   * `file_mode`
   * `dir_mode`

   *The `mountOptions` property is optional. The default values for above mount options are: ["uid=0", "gid=0", "file_mode=0777", "dir_mode=0777"]*

* I'm using the service endpoint to configure the storage account to allow access only from my own virtual network. Why did I receive *Permission Denied* while trying to mount custom persistent storage to my applications?

    *A service endpoint provides network access on a subnet level only. Be sure you've added both subnets used by the Azure Spring Apps instance to the scope of the service endpoint.*

## Next steps

* [How to use Logback to write logs to custom persistent storage](how-to-write-log-to-custom-persistent-storage.md).
* [Scale an application in Azure Spring Apps](how-to-scale-manual.md).
