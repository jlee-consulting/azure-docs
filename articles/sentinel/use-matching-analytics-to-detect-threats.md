---
title: Use matching analytics to detect threats
titleSuffix: Microsoft Sentinel
description: This article explains how to detect threats with Microsoft generated threat intelligence in Microsoft Sentinel.
author: austinmccollum
ms.topic: how-to
ms.date: 9/26/2022
ms.author: austinmc
---

# Use matching analytics to detect threats

Take advantage of threat intelligence produced by Microsoft to generate high fidelity alerts and incidents with the **Microsoft Threat Intelligence Analytics** rule. This rule will match Common Event Format (CEF) logs, Syslog data or Windows DNS events with domain, IP and URL threat indicators.

> [!IMPORTANT]
> Matching analytics is currently in PREVIEW. See the [Supplemental Terms of Use for Microsoft Azure Previews](https://azure.microsoft.com/support/legal/preview-supplemental-terms/) for additional legal terms that apply to Azure features that are in beta, preview, or otherwise not yet released into general availability.
>

## Prerequisites

One or more of the following data sources must be connected:

- Common Event Format (CEF)
- DNS (Preview)
- Syslog

:::image type="content" source="media/use-matching-analytics-to-detect-threats/data-sources.png" alt-text="A screenshot showing the Microsoft Threat Intelligence Analytics rule data source connections."::: 

## Configure the matching analytics rule

Matching analytics is configured when you enable the **Microsoft Threat Intelligence Analytics** rule. 

1. Click the **Analytics** menu from the **Configuration** section.

1. Select the **Rule templates** menu tab.

1. In the search window type *threat intelligence*.

1. Select the **Microsoft Threat Intelligence Analytics** rule template.

1. Click **Create rule**. The rule details are read only, and the default status of the rule is enabled.

1. Click **Review** > **Create**.

:::image type="content" source="media/use-matching-analytics-to-detect-threats/configure-matching-analytics-rule.png" alt-text="A screenshot showing the Microsoft Threat Intelligence Analytics rule enabled in the Active rules tab.":::

Alerts are grouped on a per-observable basis. For example, all alerts generated in a 24-hour time period that match the `contoso.com` domain are grouped into a single incident with the appropriate severity.


## Data sources and indicators

Microsoft Threat Intelligence AnalyticsÂ matches your logs with domain, IP and URL indicators in the following way:

- **CEF** logs ingested into the Log Analytics **CommonSecurityLog** table will match URL and domain indicators if populated in the `RequestURL` field, and IPv4 indicators in the `DestinationIP` field.

- Windows **DNS** logs where event `SubType == "LookupQuery"` ingested into the **DnsEvents** table will match domain indicators populated in the `Name` field, and IPv4 indicators in the `IPAddresses` field.

- **Syslog** events where `Facility == "cron"` ingested into the **Syslog** table will match domain and IPv4 indicators directly from the `SyslogMessage` field. 


## Triage an incident generated by matching analytics

If Microsoft's analytics finds a match, any alerts generated are grouped into incidents.

Use the following steps to triage through the incidents generated by the **Microsoft Threat Intelligence Analytics** rule:

1. In the Microsoft Sentinel workspace where you've enabled the **Microsoft Threat Intelligence Analytics** rule, select **Incidents** and search for **Microsoft Threat Intelligence Analytics**.

    Any incidents found are shown in the grid.

1. Select **View full details** to view entities and other details about the incident, such as specific alerts.

    For example:

    :::image type="content" source="media/work-with-threat-indicators/matching-analytics.png" alt-text="Screenshot of incident generated by matching analytics with details pane.":::

When a match is found, the indicator is also published to the Log Analytics **ThreatIntelligenceIndicators**, and displayed in the **Threat Intelligence** page. For any indicators published from this rule, the source is defined as **Microsoft Threat Intelligence Analytics**.

For example, in the **ThreatIntelligenceIndicators** log:

:::image type="content" source="media/work-with-threat-indicators/matching-analytics-logs.png" alt-text="Screenshot of ThreatIntelligenceIndicator table in Log Analytics showing recent indicator with SourceSystem of Microsoft Threat Intelligence Analytics.":::

In the **Threat Intelligence** page:

:::image type="content" source="media/work-with-threat-indicators/matching-analytics-threat-intelligence.png" alt-text="Screenshot of the Threat Intelligence overview with an indicator selecting showing the details pain and the source as Microsoft Threat Intelligence Analytics.":::

## Get additional context from Microsoft Defender Threat Intelligence

Part of the Microsoft Threat Intelligence available through matching analytics is sourced from Microsoft Defender Threat Intelligence (MDTI). Along with high fidelity alerts and incidents, MDTI indicators include the link to a reference article in their community portal.

:::image type="content" source="media/use-matching-analytics-to-detect-threats/mdti-article-link.png" alt-text="Screenshot of an incident with a link to the reference MDTI article.":::

For more information, see the [MDTI portal](https://ti.defender.microsoft.com).

## Next steps

In this article, you learned how to connect threat intelligence produced by Microsoft to generate alerts and incidents. For more information about threat intelligence in Microsoft Sentinel, see the following articles:

- [Work with threat indicators in Microsoft Sentinel](work-with-threat-indicators.md).
- Connect Microsoft Sentinel to [STIX/TAXII threat intelligence feeds](./connect-threat-intelligence-taxii.md).
- [Connect threat intelligence platforms](./connect-threat-intelligence-tip.md) to Microsoft Sentinel.
- See which [TIP platforms, TAXII feeds, and enrichments](threat-intelligence-integration.md) can be readily integrated with Microsoft Sentinel.