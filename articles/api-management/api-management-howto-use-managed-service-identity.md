---
title: Use managed identities in Azure API Management | Microsoft Docs
description: Learn how to use managed identities in API Management
services: api-management
documentationcenter: ''
author: miaojiang
manager: anneta
editor: ''

ms.service: api-management
ms.workload: integration
ms.topic: article
ms.date: 06/12/2020
ms.author: apimpm
---

# Use managed identities in Azure API Management

This article shows you how to create a managed identity for an API Management instance and how to access other resources. A managed identity generated by Azure Active Directory (Azure AD) allows your API Management instance to easily and securely access other Azure AD-protected resources, such as Azure Key Vault. This identity is managed by Azure and does not require you to provision or rotate any secrets. For more information about managed identities, see [What is managed identities for Azure resources](../active-directory/managed-identities-azure-resources/overview.md).

An API Management instance can be granted two types of identities:

- A **system-assigned identity** is tied to your service and is deleted if your service is deleted. The service can only have one system-assigned identity.
- A **user-assigned identity** is a standalone Azure resource that can be assigned to your service. The service can have multiple user-assigned identities(*).

## Create a system-assigned managed identity for an API Management instance

### Using the Azure portal

To set up a managed identity in the portal, you will first create an API Management instance as normal and then enable the feature.

1. Create an API Management instance in the portal as you normally would. Navigate to it in the portal.
2. Select **Managed identities**.
3. Within the **System assigned** tab, switch **Status** to **On**. Click **Save**.

    :::image type="content" source="./media/api-management-msi/enable-system-msi.png" alt-text="Enable System Assigned Managed-Identity." border="true":::


### Using Azure PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

The following steps will walk you through creating an API Management instance and assigning it an identity using Azure PowerShell. 

1. If needed, install the Azure PowerShell using the instructions found in the [Azure PowerShell guide](/powershell/azure/install-az-ps), and then run `Connect-AzAccount` to create a connection with Azure.

2. Create an API Management instance using Azure PowerShell. For more examples of how to use Azure PowerShell with API Management instance, see [API Management PowerShell samples](powershell-samples.md):

    ```azurepowershell-interactive
    # Create a resource group.
    New-AzResourceGroup -Name $resourceGroupName -Location $location

    # Create an API Management Consumption Sku service.
    New-AzApiManagement -ResourceGroupName $resourceGroupName -Name consumptionskuservice -Location $location -Sku Consumption -Organization contoso -AdminEmail contoso@contoso.com -SystemAssignedIdentity
    ```

3. Update and existing instance to create the identity:

    ```azurepowershell-interactive
    # Get an API Management instance
	$apimService = Get-AzApiManagement -ResourceGroupName $resourceGroupName -Name $apiManagementName

	# Update an API Management instance
	Set-AzApiManagement -InputObject $apimService -SystemAssignedIdentity
    ```

### Using the Azure Resource Manager template

You can create an API Management instance with an identity by including the following property in the resource definition:

```json
"identity" : {
    "type" : "SystemAssigned"
}
```

This tells Azure to create and manage the identity for your API Management instance.

For example, a complete Azure Resource Manager template might look like the following:

```json
{
	"$schema": "https://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
	"contentVersion": "0.9.0.0",
	"resources": [{
		"apiVersion": "2019-01-01",
		"name": "contoso",
		"type": "Microsoft.ApiManagement/service",
		"location": "[resourceGroup().location]",
		"tags": {},
		"sku": {
			"name": "Developer",
			"capacity": "1"
		},
		"properties": {
			"publisherEmail": "admin@contoso.com",
			"publisherName": "Contoso"
		},
		"identity": {
			"type": "systemAssigned"
		}
	}]
}
```

When the instance is created, it has the following additional properties:

```json
"identity": {
    "type": "SystemAssigned",
    "tenantId": "<TENANTID>",
    "principalId": "<PRINCIPALID>"
}
```

The tenantId property identifies what Azure AD tenant the identity belongs to. The principalId is a unique identifier for the instance new identity. Within Azure AD, the service principal has the same name that you gave to your API Management instance.


> [!NOTE]
> An API Management instance can have both system-assigned and user-assigned identities at the same time. In this case, the `type` property would be `SystemAssigned,UserAssigned`

### Scenarios Supported

#### <a name="use-ssl-tls-certificate-from-azure-key-vault"></a>Obtain a custom TLS/SSL certificate for the API Management instance from Azure Key Vault
The system-assigned identity of an API Management service can be used to retrieve custom TLS/SSL certificates stored in Azure Key Vault. These certificates can be assigned to custom domains in API Management instance.

1. The Content Type of the secret must be *application/x-pkcs12*.
2. The Key Vault certificate secret endpoint should be used, which contains the actual secret.

> [!Important]
> If the object version of the certificate is not provided, API Management will automatically obtain the newer version of the certificate after it is uploaded to Key Vault within 4 hours

The following example shows an Azure Resource Manager template that contains the following steps:

1. Create an API Management instance with a managed identity.
2. Update the access policies of an Azure Key Vault instance and allow the API Management instance to obtain secrets from it.
3. Update the API Management instance by setting a custom domain name through a certificate from the Key Vault instance.

```json
{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"publisherEmail": {
			"type": "string",
			"minLength": 1,
			"metadata": {
				"description": "The email address of the owner of the service"
			}
		},
		"publisherName": {
			"type": "string",
			"defaultValue": "Contoso",
			"minLength": 1,
			"metadata": {
				"description": "The name of the owner of the service"
			}
		},
		"sku": {
			"type": "string",
			"allowedValues": ["Developer",
			"Standard",
			"Premium"],
			"defaultValue": "Developer",
			"metadata": {
				"description": "The pricing tier of this API Management instance"
			}
		},
		"skuCount": {
			"type": "int",
			"defaultValue": 1,
			"metadata": {
				"description": "The instance size of this API Management instance."
			}
		},
		"keyVaultName": {
			"type": "string",
			"metadata": {
				"description": "Name of the vault"
			}
		},
		"proxyCustomHostname1": {
			"type": "string",
			"metadata": {
				"description": "Proxy Custom hostname."
			}
		},
		"keyVaultIdToCertificate": {
			"type": "string",
			"metadata": {
				"description": "Reference to the KeyVault certificate. https://contoso.vault.azure.net/secrets/contosogatewaycertificate."
			}
		}
	},
	"variables": {
		"apiManagementServiceName": "[concat('apiservice', uniqueString(resourceGroup().id))]",
		"apimServiceIdentityResourceId": "[concat(resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName')),'/providers/Microsoft.ManagedIdentity/Identities/default')]"
	},
	"resources": [{
		"apiVersion": "2019-01-01",
		"name": "[variables('apiManagementServiceName')]",
		"type": "Microsoft.ApiManagement/service",
		"location": "[resourceGroup().location]",
		"tags": {
		},
		"sku": {
			"name": "[parameters('sku')]",
			"capacity": "[parameters('skuCount')]"
		},
		"properties": {
			"publisherEmail": "[parameters('publisherEmail')]",
			"publisherName": "[parameters('publisherName')]"
		},
		"identity": {
			"type": "systemAssigned"
		}
	},
	{
		"type": "Microsoft.KeyVault/vaults/accessPolicies",
		"name": "[concat(parameters('keyVaultName'), '/add')]",
		"apiVersion": "2015-06-01",
		"dependsOn": [
			"[resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName'))]"
		],
		"properties": {
			"accessPolicies": [{
				"tenantId": "[reference(variables('apimServiceIdentityResourceId'), '2015-08-31-PREVIEW').tenantId]",
				"objectId": "[reference(variables('apimServiceIdentityResourceId'), '2015-08-31-PREVIEW').principalId]",
				"permissions": {
					"secrets": ["get"]
				}
			}]
		}
	},
	{
		"apiVersion": "2017-05-10",
		"name": "apimWithKeyVault",
		"type": "Microsoft.Resources/deployments",
		"dependsOn": [
		"[resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName'))]"
		],
		"properties": {
			"mode": "incremental",
			"templateLink": {
				"uri": "https://raw.githubusercontent.com/solankisamir/arm-templates/master/basicapim.keyvault.json",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"publisherEmail": { "value": "[parameters('publisherEmail')]"},
				"publisherName": { "value": "[parameters('publisherName')]"},
				"sku": { "value": "[parameters('sku')]"},
				"skuCount": { "value": "[parameters('skuCount')]"},
				"proxyCustomHostname1": {"value" : "[parameters('proxyCustomHostname1')]"},
				"keyVaultIdToCertificate": {"value" : "[parameters('keyVaultIdToCertificate')]"}
			}
		}
	}]
}
```

#### Authenticate using API Management Identity to the Backend

The system assigned identity can be used to authenticate to your backend using the [authentication-managed-identity](api-management-authentication-policies.md#ManagedIdentity) policy.


## Create a user-assigned managed identity for an API Management instance

> [!NOTE]
> An API Management instance can be associated with upto 10 user-assigned managed identity.

### Using the Azure portal

To set up a managed identity in the portal, you will first create an API Management instance as normal and then enable the feature.

1. Create an API Management instance in the portal as you normally would. Navigate to it in the portal.
2. Select **Managed identities**.
3. Within the **User assigned** tab, click **Add**.
4. Search for the identity you created earlier and select it. Click **Add**.

   :::image type="content" source="./media/api-management-msi/enable-user-assigned-msi.png" alt-text="Enable User Assigned Managed-Identity." border="true":::

### Using Azure PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

The following steps will walk you through creating an API Management instance and assigning it an identity using Azure PowerShell. 

1. If needed, install the Azure PowerShell using the instructions found in the [Azure PowerShell guide](/powershell/azure/install-az-ps), and then run `Connect-AzAccount` to create a connection with Azure.

2. Create an API Management instance using Azure PowerShell. For more examples of how to use Azure PowerShell with API Management instance, see [API Management PowerShell samples](powershell-samples.md):

    ```azurepowershell-interactive
    # Create a resource group.
    New-AzResourceGroup -Name $resourceGroupName -Location $location

	# Create a user-assigned identity. This requires installation of the "Az.ManagedServiceIdentity" module.
	$userAssignedIdentity = New-AzUserAssignedIdentity -Name $userAssignedIdentityName -ResourceGroupName $resourceGroupName

    # Create an API Management Consumption Sku service.
	$userIdentities = @($userAssignedIdentity.Id)

    New-AzApiManagement -ResourceGroupName $resourceGroupName -Location $location -Name $apiManagementName -Organization contoso -AdminEmail admin@contoso.com -Sku Consumption -UserAssignedIdentity $userIdentities
    ```

3. Update and existing service to assign an identity to the service.

    ```azurepowershell-interactive
    # Get an API Management instance
	$apimService = Get-AzApiManagement -ResourceGroupName $resourceGroupName -Name $apiManagementName

    # Create a user-assigned identity. This requires installation of the "Az.ManagedServiceIdentity" module.
	$userAssignedIdentity = New-AzUserAssignedIdentity -Name $userAssignedIdentityName -ResourceGroupName $resourceGroupName

	# Update an API Management instance
	$userIdentities = @($userAssignedIdentity.Id)
	Set-AzApiManagement -InputObject $apimService -UserAssignedIdentity $userIdentities
    ```

### Using the Azure Resource Manager template

You can create an API Management instance with an identity by including the following property in the resource definition:

```json
"identity": {
    "type": "UserAssigned",
    "userAssignedIdentities": {
        "<RESOURCEID>": {}
    }
}
```

Adding the user-assigned type tells Azure to use the user-assigned identity specified for your instance.

For example, a complete Azure Resource Manager template might look like the following:

```json
{
	"$schema": "https://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
	"contentVersion": "0.9.0.0",
	"resources": [{
		"apiVersion": "2019-12-01",
		"name": "contoso",
		"type": "Microsoft.ApiManagement/service",
		"location": "[resourceGroup().location]",
		"tags": {},
		"sku": {
			"name": "Developer",
			"capacity": "1"
		},
		"properties": {
			"publisherEmail": "admin@contoso.com",
			"publisherName": "Contoso"
		},
		"identity": {
			"type": "UserAssigned",
			 "userAssignedIdentities": {
				"[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]": {}
			 }
		},
	 	"dependsOn": [       
          "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
        ]
	}]
}
```

When the service is created, it has the following additional properties:

```json
"identity": {
    "type": "UserAssigned",
    "userAssignedIdentities": {
        "<RESOURCEID>": {
            "principalId": "<PRINCIPALID>",
            "clientId": "<CLIENTID>"
        }
    }
}
```

The principalId is a unique identifier for the identity that's used for Azure AD administration. The clientId is a unique identifier for the application's new identity that's used for specifying which identity to use during runtime calls.

> [!NOTE]
> An API Management instance can have both system-assigned and user-assigned identities at the same time. In this case, the `type` property would be `SystemAssigned,UserAssigned`

### Scenarios Supported

#### Authenticate using user-assigned identity to the Backend

The user assigned identity can be used to authenticate to your backend using the [authentication-managed-identity](api-management-authentication-policies.md#ManagedIdentity) policy.


## <a name="remove"></a>Remove an identity

A system-assigned identity can be removed by disabling the feature using the portal or Azure Resource Manager Template in the same way that it was created. User-assigned identities can be removed individually. To remove all identities, set the identity type to "None".

Removing a system-assigned identity in this way will also delete it from Azure AD. System-assigned identities are also automatically removed from Azure AD when the API Management instance is deleted.

To remove all identities using Azure Resource Manager Template, update this section:

```json
"identity": {
    "type": "None"
}
```

> [!Important]
> If an API Management instance is configured with custom ssl certificate from KeyVault and attempt is made to disable managed identity, the request is failed.
> Customer can unblock themselves by switching from Azure Key Vault certificate to providing inline encoded certificate and then disabling managed identity. Refer to [Configure Custom Domain](configure-custom-domain.md)

## Next steps

Learn more about managed identities for Azure resources:

* [What is managed identities for Azure resources](../active-directory/managed-identities-azure-resources/overview.md)
* [Azure Resource Manager templates](https://github.com/Azure/azure-quickstart-templates)
* [Authenticate with a managed identity in a policy](./api-management-authentication-policies.md#ManagedIdentity)
